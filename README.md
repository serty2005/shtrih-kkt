# Go-библиотека и утилита для ККТ на протоколе "Штрих-М" (poscenter, kktlab)

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

Go-библиотека и консольная утилита для взаимодействия с фискальными регистраторами (ККТ) "Штрих-М" через официальный 32-битный COM-драйвер. Проект разработан с фокусом на безопасный сбор данных в режиме "только чтение" и предоставляет гибкие режимы работы, включая автоматическое самообновление.

**Важнейшее ограничение:** Приложения, использующие эту библиотеку, **должны быть скомпилированы для 32-битной архитектуры (`GOARCH=386`)** из-за зависимости от 32-битного COM-драйвера.

## Ключевые возможности

*   **Надежная обертка над COM-драйвером:** Предоставляет безопасный и удобный Go-интерфейс для драйвера "Штрих-М".
*   **Комплексный сбор данных:** Агрегирует полную информацию о ККТ, включая регистрационные данные, статус ФН, версии ПО, лицензии и атрибуты торговли.
*   **Умный автопоиск устройств:**
    *   **COM-порты:** Автоматически сканирует все системные COM-порты на двух самых распространенных скоростях (`115200` и `4800`).
    *   **TCP/IP (RNDIS):** Cканирует стандартные для RNDIS-устройств IP-подсети (`192.168.137.0/24`, `192.168.138.0/24`).
*   **Два режима работы утилиты:**
    1.  **Режим автопоиска:** При первом запуске выполняет полный поиск устройств и **сохраняет найденные конфигурации** в `connect.json` для последующих быстрых запусков.
    2.  **Стационарный режим:** При наличии файла `connect.json` использует заданные в нем параметры для быстрого опроса конкретных ККТ.
*   **Гибкая конфигурация через `service.json`:**
    *   **Интеграция с существующей средой:** Читает настройки логирования (`log_level`, `log_days`) из общей секции `"service"`, не изменяя ее.
    *   **Собственная секция:** Управляет своими параметрами через выделенную секцию `"shtrihscanner"`, которую **автоматически создает и дополняет** при необходимости.
*   **Автоматическое самообновление:**
    *   При запуске утилита асинхронно проверяет наличие новой версии по URL, указанному в `service.json`.
    *   Безопасно скачивает и применяет обновление, проверяя целостность файла по хэш-сумме SHA256.
    *   Автоматически перезапускается для применения обновления, не прерывая основной цикл работы.
*   **Ежедневное логирование с ротацией:** Ведет подробные логи в уникальный файл на каждый день (`/logs/shtrihscanner-YYYY-MM-DD.log`). Старые лог-файлы автоматически удаляются согласно настройке `log_days` из `service.json`.
*   **Управление данными:**
    *   Сохраняет информацию о каждом ККТ в отдельный JSON-файл (`/date/{ЗН_ККТ}.json`).
    *   "Обогащает" данные ККТ информацией о рабочей станции, заимствуя ее из существующих файлов.

## Архитектура

Библиотека построена на простом интерфейсе `Driver`, что позволяет легко подменять реализации:

*   `comDriver`: Основная реализация для работы с реальным COM-драйвером.
*   `mockDriver`: Имитационная реализация для unit-тестирования.

## Начало работы

### Требования

1.  **Go:** Версия 1.17 (для совместимости с Windows 7) или выше.
2.  **Windows:** Поддержка Windows 7 и выше.
3.  **32-битный (x86) тулчейн Go:** Обязателен для компиляции.
4.  **Драйвер "Штрих-М":** На целевой машине должен быть установлен и зарегистрирован официальный драйвер Poscenter/kktlab/Штрих-М.

### Использование библиотеки в вашем проекте

1.  **Добавьте библиотеку в ваш проект:**
    ```bash
    go get github.com/serty2005/shtrih-kkt/pkg/shtrih
    ```

2.  **Пример использования:**
    ```go
    package main

    import (
        "fmt"
        "log"
        "shtrih-kkt/pkg/shtrih"
    )

    func main() {
        // Конфигурация для подключения по COM-порту
        config := shtrih.Config{
            ConnectionType: 0,
            ComName:        "COM3",
            ComNumber:      3,
            BaudRate:       6, // Индекс для 115200
            Password:       30,
        }

        // Создаем новый драйвер
        driver := shtrih.New(config)

        // Подключаемся
        if err := driver.Connect(); err != nil {
            log.Fatalf("Ошибка подключения: %v", err)
        }
        // Гарантируем отключение в конце
        defer driver.Disconnect()

        // Получаем информацию
        info, err := driver.GetFiscalInfo()
        if err != nil {
            log.Fatalf("Ошибка получения информации: %v", err)
        }

        fmt.Printf("Успешно получены данные для ККТ модели: %s\n", info.ModelName)
        fmt.Printf("Серийный номер: %s\n", info.SerialNumber)
    }
    ```

### Использование готовой утилиты `shtrihscanner.exe`

Утилита предназначена для работы в составе комплекса ПО и управляется через конфигурационные файлы.

1.  **Первый запуск (режим автопоиска):**
    *   Просто запустите `shtrihscanner.exe`.
    *   Программа выполнит полный поиск устройств и создаст `connect.json`.
    *   Если рядом будет лежать `service.json`, утилита прочитает его и автоматически **добавит в него свою секцию `shtrihscanner`**, если та отсутствует.

2.  **Стационарный режим (последующие запуски):**
    *   Убедитесь, что рядом с `.exe` лежат `connect.json` и `service.json`.
    *   При запуске утилита быстро опросит устройства из `connect.json` и параллельно запустит проверку обновлений согласно настройкам в `service.json`.

#### Конфигурационные файлы

*   `connect.json` (генерируется автоматически):
    ```json
    {
        "shtrih": [
            { "type_connect": 0, "com_port": "COM1", "com_baudrate": "115200" },
            { "type_connect": 6, "ip": "192.168.137.111", "ip_port": "7778" }
        ]
    }
    ```
*   `service.json` (управляется основной программой, наша утилита его только читает и дополняет):
    ```json
    {
        // Секция основной программы. Мы только читаем отсюда log_level и log_days.
        "service": {
            "updater_name": "mhupdater.exe",
            "log_level": "info",
            "log_days": 7
        },
        // Наша собственная секция. Будет создана и дополнена автоматически, если отсутствует.
        "shtrihscanner": {
            "enabled": true,
            "exe_name": "shtrihscanner.exe",
            "manifest_url": "http://your-server.com/path/to/update.json"
        },
        // Другие секции основной программы, которые мы не трогаем.
        "validation_fn": {
            "enabled": true
        }
    }
    ```

#### Настройка механизма самообновления

Для работы обновлений необходимо на веб-сервере разместить файл-манифест (например, `update.json`), ссылка на который указывается в `manifest_url`.

*   **Файл-манифест обновления (`update.json`):**
    ```json
    {
      "Version": "0.1.7",
      "Sha256": "a1b2c3d4e5f6...",
      "Url": "http://your-server.com/path/to/new_version.exe"
    }
    ```
    *   `Version`: Номер новой версии. Обновление начнется, только если эта версия старше текущей.
    *   `Sha256`: **Текстовая** SHA256 хэш-сумма нового `.exe` файла для проверки целостности.
    *   `Url`: Прямая ссылка на скачивание нового исполняемого файла.

## Сборка проекта

**Важно:** Сборка должна производиться для архитектуры `386`.

### Сборка для релиза (Production)

Эта команда создает компактный `.exe` файл без отладочной информации.

**Для PowerShell:**
```powershell
$env:GOARCH="386"; $env:GOOS="windows"; go build -o shtrihscanner.exe -ldflags="-s -w" -trimpath .
```

**Для CMD:**
```cmd
set GOARCH=386
set GOOS=windows
go build -o shtrihscanner.exe -ldflags="-s -w" -trimpath .
```

### Сборка без консольного окна

Для запуска в полностью фоновом режиме используйте флаг `-H=windowsgui`.

```powershell
$env:GOARCH="386"; $env:GOOS="windows"; go build -o shtrihscanner.exe -ldflags="-s -w -H=windowsgui" -trimpath .
```

## Структура проекта

```
shtrih-kkt/
├── go.mod
├── main.go                 # Основная логика утилиты
├── updater.go              # Логика механизма самообновления
├── README.md               # Этот файл
└── pkg/
    └── shtrih/
        ├── driver.go
        ├── mock_driver.go
        └── driver_test.go
---
# Файлы, создаваемые во время работы:
shtrih-scanner.exe
connect.json
service.json
date/
│   └── 0012345678901234.json
logs/
    └── 2025-10-31-shtrihscanner.log
```

## Лицензия

Этот проект распространяется под лицензией MIT. По вопросам PullRequests лучше обратиться напрямую в тг [SERTY](https://t.me/serty2005)